#!/usr/bin/bash
set -e

sudo apt-get install fastp
sudo apt-get install fastqc
sudo apt-get install bwa
sudo apt-get install samtools
sudo apt-get install bcftools

#Running FastQC
cd ~/workshop/data/untrimmed_fastq_files
echo "Running FastQC ..."
fastqc *.fastq*
mkdir -p ~/workshop/results/fastqc_untrimmed_reads
echo "Saving FastQC results..."
mv *.zip ~/workshop/results/fastqc_untrimmed_reads/
mv *.html ~/workshop/results/fastqc_untrimmed_reads/

#Unzipping the fastq file
cd ~/workshop/results/fastqc_untrimmed_reads/
echo "Unzipping..."
for filename in *.zip
    do
    unzip $filename
    done
echo "Saving summary..."
cat */summary.txt > ~/workshop/docs/fastqc_summaries.txt

#Running Fastp
mkdir qc_reads
for SAMPLE in *fastq*; do

  fastp \
    -i "$PWD/${SAMPLE}_R1.fastq.gz" \
    -I "$PWD/${SAMPLE}_R2.fastq.gz" \
    -o "qc_reads/${SAMPLE}_1.trim.sub.fastq" \
    -O "qc_reads/${SAMPLE}_2.trim.sub.fastq" \
    --html "qc_reads/${SAMPLE}_fastp.html" 
done

#Variant calling

#Supply the reference genome
mkdir ~/workshop/data/ref_genome
echo "Supply the reference genome"
echo "Input the path to the reference genome"
mv $ref_genome ~/dc_workshop/data/ref_genome
read ref_genome
gunzip ref_genome
mkdir -p results/sam results/bam results/bcf results/vcf

bwa index $ref_genome

mkdir -p sam bam bcf vcf

for fq1 in ~/dc_workshop/data/trimmed_fastq_small/*_1.trim.sub.fastq
    do
    echo "working with file $fq1"

    base=$(basename $fq1 _1.trim.sub.fastq)
    echo "base name is $base"

    fq1=~/dc_workshop/data/trimmed_fastq_small/${base}_1.trim.sub.fastq
    fq2=~/dc_workshop/data/trimmed_fastq_small/${base}_2.trim.sub.fastq
    sam=~/dc_workshop/results/sam/${base}.aligned.sam
    bam=~/dc_workshop/results/bam/${base}.aligned.bam
    sorted_bam=~/dc_workshop/results/bam/${base}.aligned.sorted.bam
    raw_bcf=~/dc_workshop/results/bcf/${base}_raw.bcf
    variants=~/dc_workshop/results/vcf/${base}_variants.vcf
    final_variants=~/dc_workshop/results/vcf/${base}_final_variants.vcf 

    bwa mem $genome $fq1 $fq2 > $sam
    samtools view -S -b $sam > $bam
    samtools sort -o $sorted_bam $bam
    samtools index $sorted_bam
    bcftools mpileup -O b -o $raw_bcf -f $genome $sorted_bam
    bcftools call --ploidy 1 -m -v -o $variants $raw_bcf 
    vcfutils.pl varFilter $variants > $final_variants
   
    done
